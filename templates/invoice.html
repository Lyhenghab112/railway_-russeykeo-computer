<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order #{{ order.id }} - Invoice - RusseyKeo Computer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        .invoice-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem; /* Reduced padding for print */
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .invoice-logo {
            height: 60px;
            width: auto;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
        }

        .action-buttons {
            margin: 10px;
        }
        .invoice-details {
            background: #f8f9fa;
            padding: 1rem; /* Reduced padding */
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .invoice-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .total-section {
            background: #e9ecef;
            padding: 0.5rem; /* Reduced padding */
            font-weight: bold;
            font-size: 1rem; /* Slightly smaller font */
        }
        .print-btn {
            background: #28a745;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
        }
        .print-btn:hover {
            background: #218838;
        }
        @media print {
            .no-print { display: none !important; }
            .invoice-header { 
                background: #667eea !important;
                -webkit-print-color-adjust: exact; /* Ensure background prints */
                color-adjust: exact;
            }
            body {
                margin: 0.5cm; /* Reduced margins for more space */
                font-size: 12pt; /* Smaller font size for print */
            }
            .container {
                width: 100% !important;
                max-width: 100% !important;
            }
            .invoice-table, .invoice-details, .total-section, .invoice-header {
                page-break-inside: avoid; /* Prevent breaking these sections */
            }
            .row {
                page-break-inside: avoid; /* Keep rows together */
            }
            @page {
                size: A4; /* Standard page size */
                margin: 0.5cm; /* Minimal margins */
            }
            table {
                font-size: 10pt; /* Smaller table font */
            }
            h1 { font-size: 20pt; } /* Smaller header */
            h4 { font-size: 14pt; }
            p { margin-bottom: 0.3rem; } /* Tighter spacing */
        }
    </style>
</head>
<body>
    <div class="container mt-2">
        <!-- Header -->
        <div class="invoice-header text-center">
            <div class="d-flex align-items-center justify-content-center mb-3">
                <img src="{{ url_for('static', filename='icons/logo.jpg') }}" alt="RusseyKeo Computer Logo" class="invoice-logo me-3">
                <div>
                    <h1 class="mb-1">RusseyKeo Computer</h1>
                    <p class="mb-0">Professional Computer Sales & Service</p>
                    <div class="mt-2">
                        <span class="badge bg-primary fs-5 px-3 py-2">Order #{{ order.id }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Approval Status Message -->
        {% if order.approval_status == 'Pending Approval' %}
        <div class="alert alert-info text-center mb-3" role="alert">
            <h5 class="alert-heading">üìã Order Confirmation</h5>
            <p class="mb-0">Thank you for your payment! We will approve your order and notify you soon.</p>
        </div>
        {% elif order.approval_status == 'Rejected' %}
        <div class="alert alert-danger text-center mb-3" role="alert">
            <h5 class="alert-heading">‚ùå Order Rejected</h5>
            <p class="mb-0">Your order has been rejected. Please contact us for more information.</p>
            {% if order.approval_notes %}
            <p class="mb-0"><strong>Reason:</strong> {{ order.approval_notes }}</p>
            {% endif %}
        </div>
        {% endif %}

        <!-- Invoice Details -->
        <div class="row">
            <div class="col-md-6">
                <div class="invoice-details">
                    <h4>üìã Invoice Details</h4>
                    <p><strong>Invoice #:</strong> {{ order.id }}</p>
                    <p><strong>Date:</strong> {{ order.order_date.strftime('%B %d, %Y') }}</p>
                    <p><strong>Time:</strong> {{ order.order_date.strftime('%I:%M %p') }}</p>
                    <p><strong>Payment Method:</strong> {{ order.payment_method or 'ACLEDA Bank QR Payment' }}</p>
                    {% if order.transaction_id %}
                    <p><strong>Transaction ID:</strong> <code class="bg-light p-1 rounded">{{ order.transaction_id }}</code></p>
                    {% endif %}
                    <p><strong>Payment Status:</strong> 
                        {% if (order.status == 'PENDING' or order.status == 'Confirmed') and order.approval_status == 'Pending Approval' %}
                            <span class="badge bg-warning">Pending Payment</span>
                        {% else %}
                            <span class="badge bg-success">Paid</span>
                        {% endif %}
                    </p>
                    {% if order.approval_status %}
                    <p><strong>Order Status:</strong>
                        {% if order.approval_status == 'Pending Approval' %}
                            <span class="badge bg-warning">Pending Approval</span>
                        {% elif order.approval_status == 'Approved' %}
                            <span class="badge bg-success">Approved</span>
                        {% elif order.approval_status == 'Rejected' %}
                            <span class="badge bg-danger">Rejected</span>
                        {% endif %}
                    </p>
                    {% endif %}
                    
                <!-- Upload Screenshot Button -->
                {% if order.payment_method == 'KHQR_BAKONG' or order.payment_method == 'Cash' or order.payment_method == 'Pay on Delivery' %}
                <div class="mt-3">
                    <div class="d-flex gap-2 flex-wrap">
                        <button onclick="showUploadScreenshotModal()" class="btn btn-warning btn-sm">
                            <i class="fas fa-camera"></i> Upload Payment Screenshot
                        </button>
                        {% if order.payment_method == 'KHQR_BAKONG' and order.status == 'PENDING' %}
                        <button onclick="showQRRegenerationModal()" class="btn btn-info btn-sm">
                            <i class="fas fa-qrcode"></i> Show QR Code
                        </button>
                        {% elif order.payment_method == 'Cash' and order.status == 'PENDING' %}
                        <button onclick="showCashQRModal()" class="btn btn-success btn-sm">
                            <i class="fas fa-qrcode"></i> Generate Cash QR
                        </button>
                        {% elif order.payment_method == 'Pay on Delivery' and order.status == 'PENDING' %}
                        <button onclick="showDeliveryQRModal()" class="btn btn-primary btn-sm">
                            <i class="fas fa-qrcode"></i> Generate Delivery QR
                        </button>
                        {% endif %}
                    </div>
                    <small class="text-muted d-block mt-1">
                        {% if order.payment_method == 'KHQR_BAKONG' %}
                            Upload your QR payment screenshot for verification
                        {% elif order.payment_method == 'Cash' %}
                            Upload your cash payment receipt for verification or generate QR code for digital payment
                        {% else %}
                            Upload your delivery payment receipt for verification or generate QR code for digital payment
                        {% endif %}
                    </small>
                </div>
                {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="invoice-details">
                    <h4>üë§ Customer Information</h4>
                    <p><strong>Name:</strong> {{ customer.first_name }} {{ customer.last_name }}</p>
                    <p><strong>Email:</strong> {{ customer.email }}</p>
                    <p><strong>Phone:</strong> {{ customer.phone or 'N/A' }}</p>
                    <!-- Atomic Address Information -->
                    <div style="margin-bottom: 15px;">
                        <strong>Address:</strong>
                        {% if detailed_address and (detailed_address.house_number or detailed_address.street_name or detailed_address.street_number or detailed_address.village or detailed_address.sangkat or detailed_address.commune or detailed_address.khan or detailed_address.province or detailed_address.postal_code or detailed_address.country or detailed_address.building_name or detailed_address.floor_number or detailed_address.unit_number or detailed_address.landmark) %}
                            <div style="margin-top: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #007bff;">
                                {% if detailed_address.house_number %}
                                <div style="margin-bottom: 3px;"><strong>House Number:</strong> {{ detailed_address.house_number }}</div>
                                {% endif %}
                                
                                {% if detailed_address.street_number or detailed_address.street_name %}
                                <div style="margin-bottom: 3px;"><strong>Street:</strong> 
                                    {% if detailed_address.street_number %}{{ detailed_address.street_number }} {% endif %}{{ detailed_address.street_name or '' }}
                                </div>
                                {% endif %}
                                
                                {% if detailed_address.village %}
                                <div style="margin-bottom: 3px;"><strong>Village:</strong> {{ detailed_address.village }}</div>
                                {% endif %}
                                
                                {% if detailed_address.sangkat %}
                                <div style="margin-bottom: 3px;"><strong>Sangkat:</strong> {{ detailed_address.sangkat }}</div>
                                {% endif %}
                                
                                {% if detailed_address.commune %}
                                <div style="margin-bottom: 3px;"><strong>Commune:</strong> {{ detailed_address.commune }}</div>
                                {% endif %}
                                
                                {% if detailed_address.khan %}
                                <div style="margin-bottom: 3px;"><strong>Khan:</strong> {{ detailed_address.khan }}</div>
                                {% endif %}
                                
                                {% if detailed_address.province %}
                                <div style="margin-bottom: 3px;"><strong>Province:</strong> {{ detailed_address.province }}</div>
                                {% endif %}
                                
                                {% if detailed_address.postal_code %}
                                <div style="margin-bottom: 3px;"><strong>Postal Code:</strong> {{ detailed_address.postal_code }}</div>
                                {% endif %}
                                
                                {% if detailed_address.country %}
                                <div style="margin-bottom: 3px;"><strong>Country:</strong> {{ detailed_address.country }}</div>
                                {% endif %}
                                
                                {% if detailed_address.building_name %}
                                <div style="margin-bottom: 3px;"><strong>Building:</strong> {{ detailed_address.building_name }}</div>
                                {% endif %}
                                
                                {% if detailed_address.floor_number or detailed_address.unit_number %}
                                <div style="margin-bottom: 3px;"><strong>Floor/Unit:</strong> 
                                    {% if detailed_address.floor_number %}Floor {{ detailed_address.floor_number }}{% endif %}
                                    {% if detailed_address.floor_number and detailed_address.unit_number %}, {% endif %}
                                    {% if detailed_address.unit_number %}Unit {{ detailed_address.unit_number }}{% endif %}
                                </div>
                                {% endif %}
                                
                                {% if detailed_address.landmark %}
                                <div style="margin-bottom: 3px;"><strong>Landmark:</strong> {{ detailed_address.landmark }}</div>
                                {% endif %}
                                
                                {% if detailed_address.delivery_notes %}
                                <div style="margin-bottom: 3px;"><strong>Delivery Notes:</strong> {{ detailed_address.delivery_notes }}</div>
                                {% endif %}
                            </div>
                        {% else %}
                            <span style="color: #6c757d;">{{ order.customer_address or 'No address information available' }}</span>
                        {% endif %}
                    </div>
                    {% if order.payment_method == 'Pay on Delivery' %}
                        {% if detailed_address and detailed_address.province %}
                            {% if 'phnom penh' in detailed_address.province.lower() or 'phnompenh' in detailed_address.province.lower() %}
                                <p><strong>Delivery Note:</strong> <span class="badge bg-success">FREE DELIVERY - Inside Phnom Penh</span></p>
                            {% else %}
                                <p><strong>Delivery Note:</strong> <span class="badge bg-warning">DELIVERY FEE APPLICABLE - Outside Phnom Penh</span></p>
                            {% endif %}
                        {% elif order.customer_address and order.customer_address != 'N/A' and order.customer_address.strip() %}
                            {% if 'phnom penh' in order.customer_address.lower() or 'phnompenh' in order.customer_address.lower() %}
                                <p><strong>Delivery Note:</strong> <span class="badge bg-success">FREE DELIVERY - Inside Phnom Penh</span></p>
                            {% else %}
                                <p><strong>Delivery Note:</strong> <span class="badge bg-warning">DELIVERY FEE APPLICABLE - Outside Phnom Penh</span></p>
                            {% endif %}
                        {% else %}
                            <p><strong>Delivery Note:</strong> <span class="badge bg-danger">ADDRESS REQUIRED - Please contact customer for delivery address</span></p>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Items Table -->
        <div class="invoice-table">
            <div class="table-header bg-primary text-white p-3">
                <h5 class="mb-0">üì¶ Order Items - Order #{{ order.id }}</h5>
            </div>
            <table class="table table-striped mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Product</th>
                        <th>Brand</th>
                        <th>Quantity</th>
                        <th>Original Price</th>
                        <th>Discount</th>
                        <th>Final Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in order_items %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>
                            {{ item.product_name }}
                            {% if item.has_discount %}
                            <span class="badge bg-success ms-2">üí∞ Discounted</span>
                            {% endif %}
                        </td>
                        <td>{{ item.brand }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>
                            {% if item.has_discount %}
                            <span class="text-muted text-decoration-line-through">${{ "%.2f"|format(item.original_price) }}</span>
                            {% else %}
                            ${{ "%.2f"|format(item.original_price) }}
                            {% endif %}
                        </td>
                        <td>
                            {% if item.has_discount %}
                            <span class="text-success fw-bold">
                                -{{ "%.1f"|format(item.discount_percentage) }}%<br>
                                <small>(-${{ "%.2f"|format(item.discount_amount) }})</small>
                            </span>
                            {% else %}
                            <span class="text-muted">No discount</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.has_discount %}
                            <span class="text-success fw-bold">${{ "%.2f"|format(item.price) }}</span>
                            {% else %}
                            ${{ "%.2f"|format(item.price) }}
                            {% endif %}
                        </td>
                        <td>
                            <strong>${{ "%.2f"|format(item.quantity * item.price) }}</strong>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Total Section -->
            <div class="total-section text-end">
                <div class="row">
                    <div class="col-md-8"></div>
                    <div class="col-md-4">
                        {% if invoice_summary.has_discounts %}
                        <p class="mb-1">Original Subtotal: <span class="text-muted text-decoration-line-through">${{ "%.2f"|format(invoice_summary.original_total) }}</span></p>

                        {% if invoice_summary.item_discount_total > 0 %}
                        <p class="mb-1 text-success">Item Discounts: -${{ "%.2f"|format(invoice_summary.item_discount_total) }}</p>
                        {% endif %}

                        {% if invoice_summary.has_volume_discount %}
                        <p class="mb-1">Subtotal after item discounts: ${{ "%.2f"|format(invoice_summary.subtotal_before_volume_discount) }}</p>
                        <p class="mb-1 text-success">
                            <i class="fas fa-gift"></i> {{ invoice_summary.volume_discount_rule_name }}:
                            {{ "%.1f"|format(invoice_summary.volume_discount_percentage) }}% off
                            (-${{ "%.2f"|format(invoice_summary.volume_discount_amount) }})
                        </p>
                        {% endif %}

                        <p class="mb-1">Final Subtotal: ${{ "%.2f"|format(order.total_amount) }}</p>
                        {% else %}
                        <p class="mb-1">Subtotal: ${{ "%.2f"|format(order.total_amount) }}</p>
                        {% endif %}

                        <hr>
                        <h4>üí∞ Total Paid: ${{ "%.2f"|format(order.total_amount) }}</h4>
                        {% if invoice_summary.has_discounts %}
                        <p class="text-success mb-0">
                            <small>üéâ You saved ${{ "%.2f"|format(invoice_summary.total_discount) }} on this order!</small>
                            {% if invoice_summary.has_volume_discount %}
                            <br><small>üí° Volume discount applied for orders over ${{ "%.0f"|format(500 if invoice_summary.volume_discount_percentage == 5 else (1000 if invoice_summary.volume_discount_percentage == 10 else 2000)) }}</small>
                            {% endif %}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Info -->
        <div class="row mt-2">
            <div class="col-md-12">
                <div class="invoice-details text-center">
                    <h5>‚úÖ Payment Confirmed</h5>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="text-center mt-2 no-print action-buttons">
            <button onclick="window.print()" class="btn print-btn me-3">
                üñ®Ô∏è Print Invoice
            </button>
            <a href="{{ url_for('show_dashboard') }}" class="btn btn-secondary">
                ‚Üê Homepage
            </a>
        </div>
    </div>

    <!-- Upload Screenshot Modal -->
    <div id="uploadScreenshotModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; margin: 50px auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0; text-align: center;">
                <h2 style="margin: 0; font-size: 1.8rem;">
                    <i class="fas fa-credit-card" style="margin-right: 10px;"></i>
                    Upload Payment Proof
                </h2>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">Upload your payment screenshot to verify your order!</p>
            </div>
            
            <div class="modal-body" style="padding: 30px;">
                <form id="payment-verification-form" enctype="multipart/form-data">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                            <i class="fas fa-magic"></i> Order ID
                        </label>
                        <input type="number" id="order-id" name="order_id" class="form-control" 
                               value="{{ order.id }}" readonly
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; background-color: #f8f9fa;">
                        <small style="color: #666; font-size: 14px; margin-top: 5px; display: block;">
                            Order ID is pre-filled for this invoice.
                        </small>
                    </div>

                    {% if order.transaction_id and order.transaction_id != 'None' %}
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="transaction-id" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                            <i class="fas fa-hashtag"></i> Transaction ID
                        </label>
                        <input type="text" id="transaction-id" name="transaction_id" class="form-control" 
                               value="{{ order.transaction_id }}" readonly
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; background-color: #f8f9fa;">
                        <small style="color: #666; font-size: 14px;">
                            Transaction ID from your QR payment scan.
                        </small>
                    </div>
                    {% endif %}

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                            <i class="fas fa-upload"></i> Payment Proof (Required)
                        </label>
                        <div id="file-upload-area" style="border: 2px dashed #007bff; border-radius: 8px; padding: 30px; text-align: center; background: #f8f9fa; cursor: pointer; transition: all 0.3s ease;">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #007bff; margin-bottom: 15px;"></i>
                            <p style="margin: 0; font-size: 16px; color: #333;">Click to upload or drag and drop</p>
                            <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;">Supports: JPG, PNG, PDF (Max 10MB)</p>
                        </div>
                        <input type="file" id="payment-screenshot" name="payment_screenshot" accept=".jpg,.jpeg,.png,.pdf" style="display: none;">
                        <div id="file-preview" style="display: none; margin-top: 15px; padding: 15px; background: #e8f5e8; border-radius: 8px; border: 1px solid #28a745;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <i class="fas fa-file-image" style="color: #28a745; margin-right: 10px;"></i>
                                    <span id="file-name" style="font-weight: bold;"></span>
                                </div>
                                <button type="button" id="remove-file" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="payment-notes" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                            <i class="fas fa-comment"></i> Additional Notes (Optional)
                        </label>
                        <textarea id="payment-notes" name="payment_notes" class="form-control" rows="3" 
                                  placeholder="Any additional information about your payment..."
                                  style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; resize: vertical;"></textarea>
                    </div>

                    <div id="verification-result" style="display: none; margin-bottom: 20px;"></div>

                    <div style="text-align: center;">
                        <button type="submit" id="submit-btn" class="btn btn-success" style="padding: 12px 30px; font-size: 16px; margin-right: 10px;">
                            <i class="fas fa-upload"></i> Upload Payment Proof
                        </button>
                        <button type="button" onclick="closeUploadModal()" class="btn btn-secondary" style="padding: 12px 30px; font-size: 16px;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- QR Regeneration Modal -->
    <div id="qrRegenerationModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; margin: 50px auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0; text-align: center;">
                <h2 style="margin: 0; font-size: 1.8rem;">
                    <i class="fas fa-qrcode" style="margin-right: 10px;"></i>
                    QR Payment Code
                </h2>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">Scan this QR code to complete your payment</p>
            </div>
            
            <div class="modal-body" style="padding: 30px; text-align: center;">
                <div id="qr-loading" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating QR code...</p>
                </div>
                
                <div id="qr-content" style="display: none;">
                    <div id="qr-code-container" class="mb-3">
                        <!-- QR code will be inserted here -->
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Payment Instructions:</h6>
                        <ol class="text-start mb-0">
                            <li>Open your mobile banking app (ACLEDA, ABA, Wing, etc.)</li>
                            <li>Find the QR payment/scan option</li>
                            <li>Scan this QR code to pay</li>
                            <li>Complete the payment in your banking app</li>
                        </ol>
                    </div>
                    
                    <div class="alert alert-warning">
                        <small><i class="fas fa-clock"></i> This QR code is valid for 15 minutes</small>
                    </div>
                </div>
                
                <div id="qr-error" style="display: none;" class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle"></i> Error</h6>
                    <p id="qr-error-message">Failed to generate QR code. Please try again.</p>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 20px; text-align: center; border-top: 1px solid #eee;">
                <button onclick="closeQRModal()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Close
                </button>
                <button onclick="downloadQRCode()" id="download-qr-btn" class="btn btn-success" style="display: none;">
                    <i class="fas fa-download"></i> Download QR
                </button>
            </div>
        </div>
    </div>

    <!-- Cash QR Modal -->
    <div id="cashQRModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; margin: 50px auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0; text-align: center;">
                <h2 style="margin: 0; font-size: 1.8rem;">
                    <i class="fas fa-qrcode" style="margin-right: 10px;"></i>
                    Cash Payment QR
                </h2>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">Generate QR code for digital cash payment</p>
            </div>
            
            <div class="modal-body" style="padding: 30px; text-align: center;">
                <div id="cash-qr-loading" class="text-center">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating Cash QR code...</p>
                </div>
                
                <div id="cash-qr-content" style="display: none;">
                    <div id="cash-qr-code-container" class="mb-3">
                        <!-- QR code will be inserted here -->
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Payment Instructions:</h6>
                        <ol class="text-start mb-0">
                            <li>Open your mobile banking app (ACLEDA, ABA, Wing, etc.)</li>
                            <li>Find the QR payment/scan option</li>
                            <li>Scan this QR code to pay</li>
                            <li>Complete the payment in your banking app</li>
                            <li>Upload payment screenshot for verification</li>
                        </ol>
                    </div>
                    
                    <div class="alert alert-warning">
                        <small><i class="fas fa-clock"></i> This QR code is valid for 15 minutes</small>
                    </div>
                </div>
                
                <div id="cash-qr-error" style="display: none;" class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle"></i> Error</h6>
                    <p id="cash-qr-error-message">Failed to generate QR code. Please try again.</p>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 20px; text-align: center; border-top: 1px solid #eee;">
                <button onclick="closeCashQRModal()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Close
                </button>
                <button onclick="downloadCashQRCode()" id="download-cash-qr-btn" class="btn btn-success" style="display: none;">
                    <i class="fas fa-download"></i> Download QR
                </button>
            </div>
        </div>
    </div>

    <!-- Pay on Delivery QR Modal -->
    <div id="deliveryQRModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; margin: 50px auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #007bff 0%, #6610f2 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0; text-align: center;">
                <h2 style="margin: 0; font-size: 1.8rem;">
                    <i class="fas fa-qrcode" style="margin-right: 10px;"></i>
                    Delivery Payment QR
                </h2>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">Generate QR code for delivery payment</p>
            </div>
            
            <div class="modal-body" style="padding: 30px; text-align: center;">
                <div id="delivery-qr-loading" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating Delivery QR code...</p>
                </div>
                
                <div id="delivery-qr-content" style="display: none;">
                    <div id="delivery-qr-code-container" class="mb-3">
                        <!-- QR code will be inserted here -->
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Payment Instructions:</h6>
                        <ol class="text-start mb-0">
                            <li>Open your mobile banking app (ACLEDA, ABA, Wing, etc.)</li>
                            <li>Find the QR payment/scan option</li>
                            <li>Scan this QR code to pay</li>
                            <li>Complete the payment in your banking app</li>
                            <li>Upload payment screenshot for verification</li>
                        </ol>
                    </div>
                    
                    <div class="alert alert-warning">
                        <small><i class="fas fa-clock"></i> This QR code is valid for 15 minutes</small>
                    </div>
                </div>
                
                <div id="delivery-qr-error" style="display: none;" class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle"></i> Error</h6>
                    <p id="delivery-qr-error-message">Failed to generate QR code. Please try again.</p>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 20px; text-align: center; border-top: 1px solid #eee;">
                <button onclick="closeDeliveryQRModal()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Close
                </button>
                <button onclick="downloadDeliveryQRCode()" id="download-delivery-qr-btn" class="btn btn-success" style="display: none;">
                    <i class="fas fa-download"></i> Download QR
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Upload Screenshot Modal Functions
        function showUploadScreenshotModal() {
            document.getElementById('uploadScreenshotModal').style.display = 'block';
        }

        function closeUploadModal() {
            document.getElementById('uploadScreenshotModal').style.display = 'none';
            // Reset form
            document.getElementById('payment-verification-form').reset();
            document.getElementById('file-preview').style.display = 'none';
            document.getElementById('verification-result').style.display = 'none';
        }

        // File upload handling
        const fileUploadArea = document.getElementById('file-upload-area');
        const fileInput = document.getElementById('payment-screenshot');
        const filePreview = document.getElementById('file-preview');
        const fileName = document.getElementById('file-name');
        const removeFileBtn = document.getElementById('remove-file');

        fileUploadArea.addEventListener('click', () => fileInput.click());
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = '#28a745';
            fileUploadArea.style.backgroundColor = '#e8f5e8';
        });
        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.style.borderColor = '#007bff';
            fileUploadArea.style.backgroundColor = '#f8f9fa';
        });
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = '#007bff';
            fileUploadArea.style.backgroundColor = '#f8f9fa';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        });

        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (file) {
                fileName.textContent = file.name;
                filePreview.style.display = 'block';
            }
        }

        removeFileBtn.addEventListener('click', () => {
            fileInput.value = '';
            filePreview.style.display = 'none';
        });

        // Form submission
        document.getElementById('payment-verification-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            const resultDiv = document.getElementById('verification-result');
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('/api/payment/verify-upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h4><i class="fas fa-check-circle"></i> Payment Proof Uploaded Successfully!</h4>
                            <p><strong>Order #{{ order.id }}</strong> payment proof has been uploaded!</p>
                            <p>Our staff will review it and notify you soon.</p>
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    
                    // Reset form
                    e.target.reset();
                    filePreview.style.display = 'none';
                    
                    // Close modal after 3 seconds
                    setTimeout(() => {
                        closeUploadModal();
                        // Refresh page to show updated status
                        window.location.reload();
                    }, 3000);
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h4><i class="fas fa-exclamation-triangle"></i> Upload Failed</h4>
                            <p>${result.error}</p>
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h4><i class="fas fa-exclamation-triangle"></i> Upload Error</h4>
                        <p>An error occurred while uploading. Please try again.</p>
                    </div>
                `;
                resultDiv.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Payment Proof';
            }
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('uploadScreenshotModal');
            if (e.target === modal) {
                closeUploadModal();
            }
        });

        // QR Regeneration Modal Functions
        function showQRRegenerationModal() {
            document.getElementById('qrRegenerationModal').style.display = 'block';
            generateQRCode();
        }

        function closeQRModal() {
            document.getElementById('qrRegenerationModal').style.display = 'none';
            // Reset modal state
            document.getElementById('qr-loading').style.display = 'block';
            document.getElementById('qr-content').style.display = 'none';
            document.getElementById('qr-error').style.display = 'none';
            document.getElementById('download-qr-btn').style.display = 'none';
        }

        async function generateQRCode() {
            const orderId = {{ order.id }};
            const loadingDiv = document.getElementById('qr-loading');
            const contentDiv = document.getElementById('qr-content');
            const errorDiv = document.getElementById('qr-error');
            const qrContainer = document.getElementById('qr-code-container');
            const downloadBtn = document.getElementById('download-qr-btn');

            try {
                // Show loading state
                loadingDiv.style.display = 'block';
                contentDiv.style.display = 'none';
                errorDiv.style.display = 'none';

                // Call API to regenerate QR with same MD5
                const response = await fetch(`/api/orders/${orderId}/regenerate-qr`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // Hide loading, show content
                    loadingDiv.style.display = 'none';
                    contentDiv.style.display = 'block';

                    // Generate QR code image
                    qrContainer.innerHTML = '';
                    if (typeof QRCode !== 'undefined') {
                        new QRCode(qrContainer, {
                            text: result.qr_data,
                            width: 250,
                            height: 250,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.M
                        });
                    } else {
                        // Fallback: Use online QR code generator
                        const qrImg = document.createElement('img');
                        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(result.qr_data)}`;
                        qrImg.style.width = '250px';
                        qrImg.style.height = '250px';
                        qrImg.style.border = '1px solid #ddd';
                        qrImg.style.borderRadius = '8px';
                        qrContainer.appendChild(qrImg);
                    }

                    // Show download button
                    downloadBtn.style.display = 'inline-block';
                    downloadBtn.onclick = () => downloadQRCode(result.qr_data);

                } else {
                    throw new Error(result.error || 'Failed to generate QR code');
                }

            } catch (error) {
                console.error('QR generation error:', error);
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                document.getElementById('qr-error-message').textContent = error.message;
            }
        }

        function downloadQRCode(qrData) {
            if (!qrData) {
                // Get QR data from the current QR code image
                const qrImg = document.querySelector('#qr-code-container img');
                if (qrImg) {
                    qrData = qrImg.src.split('data=')[1];
                }
            }

            if (qrData) {
                // Create download link
                const link = document.createElement('a');
                link.href = `https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=${encodeURIComponent(qrData)}`;
                link.download = `qr-payment-order-{{ order.id }}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Close QR modal when clicking outside
        window.addEventListener('click', (e) => {
            const qrModal = document.getElementById('qrRegenerationModal');
            if (e.target === qrModal) {
                closeQRModal();
            }
        });

        // Cash QR Modal Functions
        function showCashQRModal() {
            document.getElementById('cashQRModal').style.display = 'block';
            generateCashQRCode();
        }

        function closeCashQRModal() {
            document.getElementById('cashQRModal').style.display = 'none';
            // Reset modal state
            document.getElementById('cash-qr-loading').style.display = 'block';
            document.getElementById('cash-qr-content').style.display = 'none';
            document.getElementById('cash-qr-error').style.display = 'none';
            document.getElementById('download-cash-qr-btn').style.display = 'none';
        }

        async function generateCashQRCode() {
            const orderId = {{ order.id }};
            const cashLoadingDiv = document.getElementById('cash-qr-loading');
            const cashContentDiv = document.getElementById('cash-qr-content');
            const cashErrorDiv = document.getElementById('cash-qr-error');
            const cashQrContainer = document.getElementById('cash-qr-code-container');
            const cashDownloadBtn = document.getElementById('download-cash-qr-btn');

            try {
                // Show loading state
                cashLoadingDiv.style.display = 'block';
                cashContentDiv.style.display = 'none';
                cashErrorDiv.style.display = 'none';

                // Call API to generate Cash QR
                const response = await fetch(`/api/orders/${orderId}/generate-cash-qr`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // Hide loading, show content
                    cashLoadingDiv.style.display = 'none';
                    cashContentDiv.style.display = 'block';

                    // Generate QR code image
                    cashQrContainer.innerHTML = '';
                    if (typeof QRCode !== 'undefined') {
                        new QRCode(cashQrContainer, {
                            text: result.qr_data,
                            width: 250,
                            height: 250,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.M
                        });
                    } else {
                        // Fallback: Use online QR code generator
                        const qrImg = document.createElement('img');
                        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(result.qr_data)}`;
                        qrImg.style.width = '250px';
                        qrImg.style.height = '250px';
                        qrImg.style.border = '1px solid #ddd';
                        qrImg.style.borderRadius = '8px';
                        cashQrContainer.appendChild(qrImg);
                    }

                    // Show download button
                    cashDownloadBtn.style.display = 'inline-block';
                    cashDownloadBtn.onclick = () => downloadCashQRCode(result.qr_data);

                } else {
                    throw new Error(result.error || 'Failed to generate Cash QR code');
                }

            } catch (error) {
                console.error('Cash QR generation error:', error);
                cashLoadingDiv.style.display = 'none';
                cashErrorDiv.style.display = 'block';
                document.getElementById('cash-qr-error-message').textContent = error.message;
            }
        }

        function downloadCashQRCode(qrData) {
            if (!qrData) {
                // Get QR data from the current QR code image
                const qrImg = document.querySelector('#cash-qr-code-container img');
                if (qrImg) {
                    qrData = qrImg.src.split('data=')[1];
                }
            }

            if (qrData) {
                // Create download link
                const link = document.createElement('a');
                link.href = `https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=${encodeURIComponent(qrData)}`;
                link.download = `cash-qr-payment-order-{{ order.id }}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Delivery QR Modal Functions
        function showDeliveryQRModal() {
            document.getElementById('deliveryQRModal').style.display = 'block';
            generateDeliveryQRCode();
        }

        function closeDeliveryQRModal() {
            document.getElementById('deliveryQRModal').style.display = 'none';
            // Reset modal state
            document.getElementById('delivery-qr-loading').style.display = 'block';
            document.getElementById('delivery-qr-content').style.display = 'none';
            document.getElementById('delivery-qr-error').style.display = 'none';
            document.getElementById('download-delivery-qr-btn').style.display = 'none';
        }

        async function generateDeliveryQRCode() {
            const orderId = {{ order.id }};
            const deliveryLoadingDiv = document.getElementById('delivery-qr-loading');
            const deliveryContentDiv = document.getElementById('delivery-qr-content');
            const deliveryErrorDiv = document.getElementById('delivery-qr-error');
            const deliveryQrContainer = document.getElementById('delivery-qr-code-container');
            const deliveryDownloadBtn = document.getElementById('download-delivery-qr-btn');

            try {
                // Show loading state
                deliveryLoadingDiv.style.display = 'block';
                deliveryContentDiv.style.display = 'none';
                deliveryErrorDiv.style.display = 'none';

                // Call API to generate Delivery QR
                const response = await fetch(`/api/orders/${orderId}/generate-delivery-qr`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // Hide loading, show content
                    deliveryLoadingDiv.style.display = 'none';
                    deliveryContentDiv.style.display = 'block';

                    // Generate QR code image
                    deliveryQrContainer.innerHTML = '';
                    if (typeof QRCode !== 'undefined') {
                        new QRCode(deliveryQrContainer, {
                            text: result.qr_data,
                            width: 250,
                            height: 250,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.M
                        });
                    } else {
                        // Fallback: Use online QR code generator
                        const qrImg = document.createElement('img');
                        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(result.qr_data)}`;
                        qrImg.style.width = '250px';
                        qrImg.style.height = '250px';
                        qrImg.style.border = '1px solid #ddd';
                        qrImg.style.borderRadius = '8px';
                        deliveryQrContainer.appendChild(qrImg);
                    }

                    // Show download button
                    deliveryDownloadBtn.style.display = 'inline-block';
                    deliveryDownloadBtn.onclick = () => downloadDeliveryQRCode(result.qr_data);

                } else {
                    throw new Error(result.error || 'Failed to generate Delivery QR code');
                }

            } catch (error) {
                console.error('Delivery QR generation error:', error);
                deliveryLoadingDiv.style.display = 'none';
                deliveryErrorDiv.style.display = 'block';
                document.getElementById('delivery-qr-error-message').textContent = error.message;
            }
        }

        function downloadDeliveryQRCode(qrData) {
            if (!qrData) {
                // Get QR data from the current QR code image
                const qrImg = document.querySelector('#delivery-qr-code-container img');
                if (qrImg) {
                    qrData = qrImg.src.split('data=')[1];
                }
            }

            if (qrData) {
                // Create download link
                const link = document.createElement('a');
                link.href = `https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=${encodeURIComponent(qrData)}`;
                link.download = `delivery-qr-payment-order-{{ order.id }}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            const cashQRModal = document.getElementById('cashQRModal');
            const deliveryQRModal = document.getElementById('deliveryQRModal');
            if (e.target === cashQRModal) {
                closeCashQRModal();
            }
            if (e.target === deliveryQRModal) {
                closeDeliveryQRModal();
            }
        });
    </script>

    <!-- Footer -->
    <div class="container mt-4 mb-3">
        <div class="text-center text-muted">
            <hr>
            <p class="mb-1"><strong>Order Reference:</strong> #{{ order.id }}</p>
            <p class="mb-0">Thank you for choosing RusseyKeo Computer!</p>
        </div>
    </div>
</body>
</html>